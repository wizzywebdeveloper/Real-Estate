<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Set New Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { supabase } from './supabase.js';
        window.supabaseClient = supabase;
    </script>
    <style>
        #strength-bar { transition: width 0.3s ease, background-color 0.3s ease; }
    </style>
</head>
<body class="bg-slate-900 flex items-center justify-center h-screen">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-2 text-slate-800 text-center">New Password</h2>
        <p class="text-slate-500 text-sm text-center mb-6">Enter your new agent password below.</p>
        
        <form id="resetForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700">New Password</label>
                <input type="password" id="newPassword" required minlength="6" placeholder="••••••••" class="w-full p-3 border rounded-lg mt-1 outline-blue-500">
                
                <div class="mt-2 h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div id="strength-bar" class="h-full w-0 bg-red-500"></div>
                </div>
                <p id="strength-text" class="text-[10px] uppercase font-bold mt-1 text-slate-400">Strength: Too Weak</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700">Confirm Password</label>
                <input type="password" id="confirmPassword" required minlength="6" placeholder="••••••••" class="w-full p-3 border rounded-lg mt-1 outline-blue-500">
                
                <div class="mt-2 flex items-center">
                    <input type="checkbox" id="togglePassword" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded cursor-pointer">
                    <label for="togglePassword" class="ml-2 block text-xs text-slate-600 cursor-pointer select-none">Show Passwords</label>
                </div>
            </div>
            
            <button type="submit" id="resetBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition">Update Password</button>
            <p id="message" class="text-sm text-center hidden mt-4 font-medium"></p>
        </form>
    </div>

    <script>
        // We wait for the module to finish importing supabase
        window.addEventListener('load', () => {
            const checkInit = setInterval(() => {
                if (window.supabaseClient) {
                    clearInterval(checkInit);
                    initPage(window.supabaseClient);
                }
            }, 100);
        });

        function initPage(supabase) {
            const resetForm = document.getElementById('resetForm');
            const msg = document.getElementById('message');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const toggleCheckbox = document.getElementById('togglePassword');
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');

            newPasswordInput.addEventListener('input', () => {
                const val = newPasswordInput.value;
                let score = 0;
                if (val.length > 6) score++;
                if (val.length > 10) score++;
                if (/[A-Z]/.test(val)) score++;
                if (/[0-9]/.test(val)) score++;
                if (/[^A-Za-z0-9]/.test(val)) score++;

                const widths = ['20%', '40%', '60%', '80%', '100%'];
                const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'];
                const labels = ['Weak', 'Fair', 'Good', 'Strong', 'Very Strong'];

                strengthBar.style.width = widths[score - 1] || '0%';
                strengthBar.className = `h-full transition-all duration-300 ${colors[score - 1] || 'bg-red-500'}`;
                strengthText.innerText = `Strength: ${labels[score - 1] || 'Too Weak'}`;
            });

            toggleCheckbox.addEventListener('change', function() {
                const type = this.checked ? 'text' : 'password';
                newPasswordInput.type = type;
                confirmPasswordInput.type = type;
            });

            resetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = newPasswordInput.value;
                if (newPassword !== confirmPasswordInput.value) {
                    msg.innerText = "Passwords do not match!";
                    msg.className = "text-red-500 text-sm text-center mt-4 font-medium block";
                    msg.classList.remove('hidden');
                    return;
                }

                const { error } = await supabase.auth.updateUser({ password: newPassword });

                if (error) {
                    msg.innerText = error.message;
                    msg.className = "text-red-500 text-sm text-center mt-4 font-medium block";
                } else {
                    msg.innerText = "Password updated! Redirecting to login...";
                    msg.className = "text-green-600 text-sm text-center mt-4 font-medium block";
                    setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                }
                msg.classList.remove('hidden');
            });
        }
    </script>
</body>
</html>